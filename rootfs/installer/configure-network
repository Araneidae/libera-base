#!/bin/sh

# Script for configuring the network.  As this is surprisingly involved, this
# is placed in a separate script.

HERE="$(dirname "$0")"
. "$HERE"/functions


# Helper function for the two functions below, called thus:
#
#   compute_elements ip mask action
#
# Returns an IP address generated by applying action to each component of ip
# and mask in turn
compute_elements()
{
    local IFS=.
    MASK="$2"

    dot=
    for ip in $1; do
        mask="${MASK%%.*}"
        MASK="${MASK#*.}"
        echo -n "$dot"
        dot=.
        eval echo -n '$(('$3'))'
    done
}

# From an IP address and a net mask computes the associated network as
#   IP & mask
compute_network()   { compute_elements $1 $2 'ip & mask'; }
compute_broadcast() { compute_elements $1 $2 '255 & ~(mask & ~ip)'; }


IPADDR="$(read_config ipaddr)"
NETMASK="$(read_config netmask)"

cat <<EOF >>/mnt/mtd4/etc/network/interfaces

auto eth0
iface eth0 inet static
    address $IPADDR
    network $(compute_network $IPADDR $NETMASK)
    netmask $NETMASK
    broadcast $(compute_broadcast $IPADDR $NETMASK)
    gateway $(read_config gatewayip)
EOF

echo "$(read_config hostname)" >/mnt/mtd4/etc/hostname
